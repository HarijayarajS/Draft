use axum::{Json, Router, routing::post};
use serde::{Deserialize, Serialize};
use utoipa::{OpenApi, ToSchema};
use utoipa_axum::router::OpenApiRouter;

/// Example request type
#[derive(Deserialize, ToSchema)]
struct ProductRequest {
    category: String,
}

/// Example response type
#[derive(Serialize, ToSchema)]
struct ProductResponse {
    id: i32,
    name: String,
}

/// Your handler for `/products/list`
async fn handler_get_list(Json(req): Json<ProductRequest>) -> Json<Vec<ProductResponse>> {
    println!("Got category = {}", req.category);

    Json(vec![
        ProductResponse { id: 1, name: "Item A".into() },
        ProductResponse { id: 2, name: "Item B".into() },
    ])
}

/// OpenAPI spec
#[derive(OpenApi)]
#[openapi(
    components(schemas(ProductRequest, ProductResponse)),
    // You don't need to repeat the path here â€” utoipa-axum maps it from the Router
)]
struct ApiDoc;

#[tokio::main]
async fn main() {
    let app = OpenApiRouter::with_openapi(ApiDoc::openapi())
        .routes(|router| {
            router.route("/products/list", post(handler_get_list))
        })
        // serve the JSON spec at /api-docs/openapi.json
        .route("/api-docs/openapi.json", post(|| async { "spec here" }));

    println!("Server running at http://localhost:3000");

    axum::Server::bind(&"0.0.0.0:3000".parse().unwrap())
        .serve(app.into_make_service())
        .await
        .unwrap();
}




[package]
name = "server-api"
version = "0.1.0"
edition = "2021"

[dependencies]
axum = "0.7"
tokio = { version = "1", features = ["full"] }
serde = { version = "1", features = ["derive"] }
utoipa = "5"
utoipa-axum = "0.1"







use axum::{Router, routing::post};
use utoipa::OpenApi;
use utoipa_axum::{router::OpenApiRouter, routes};

mod product;

#[derive(OpenApi)]
#[openapi(
    // No need to duplicate paths here if using the `routes!` macro
    components(schemas(
        product::ProductRequest,
        product::ProductResponse,
        product::ProductCreate,
        product::ProductCreateResponse
    ))
)]
struct ApiDoc;

#[tokio::main]
async fn main() {
    // Build the OpenApiRouter and split into router + spec
    let (axum_router, openapi_spec) = OpenApiRouter::new()
        .routes(routes!(
            product::handler_get_list,
            product::handler_create
        ))
        .split_for_parts();

    // Merge with yourself-defined routes or expose API doc
    let app = axum_router
        .route("/api-docs/openapi.json", post(move || async move {
            axum::Json(openapi_spec.clone())
        }));

    println!("Server running at http://localhost:3000");

    let listener = tokio::net::TcpListener::bind("0.0.0.0:3000")
        .await
        .unwrap();

    axum::serve(listener, app).await.unwrap();
}